# Example: Continuous Build with Specular
#
# This workflow implements spec-first continuous builds:
# 1. Generates spec from PRD on changes
# 2. Generates execution plan
# 3. Executes build with policy enforcement
# 4. Runs comprehensive validation
#
# To use this workflow:
# 1. Copy to .github/workflows/continuous-build.yml
# 2. Set up required secrets for AI providers
# 3. Configure policy file and build settings

name: Continuous Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'PRD.md'
      - '.specular/**'
      - 'src/**'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  spec-generation:
    name: Generate Specification
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'PRD.md')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Spec from PRD
        uses: ./
        with:
          command: 'spec'
          prd-file: 'PRD.md'
          spec-file: '.specular/spec.yaml'
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          verbose: 'true'

      - name: Upload Spec Artifact
        uses: actions/upload-artifact@v4
        with:
          name: specification
          path: .specular/spec.yaml
          retention-days: 30

  plan-generation:
    name: Generate Build Plan
    runs-on: ubuntu-latest
    needs: [ spec-generation ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Spec
        uses: actions/download-artifact@v4
        with:
          name: specification
          path: .specular/

      - name: Generate Build Plan
        uses: ./
        with:
          command: 'plan'
          spec-file: '.specular/spec.yaml'
          policy-file: '.specular/policy.yaml'
          plan-file: 'build-plan.json'
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-plan
          path: build-plan.json
          retention-days: 7

  build:
    name: Execute Build
    runs-on: ubuntu-latest
    needs: [ plan-generation ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Download Build Plan
        uses: actions/download-artifact@v4
        with:
          name: build-plan

      - name: Execute Build with Policy Enforcement
        uses: ./
        with:
          command: 'build'
          plan-file: 'build-plan.json'
          policy-file: '.specular/policy.yaml'
          checkpoint-resume: 'true'
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          verbose: 'true'

      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            .specular/runs/
            **/*.log
          retention-days: 7

  validate:
    name: Validate Build
    runs-on: ubuntu-latest
    needs: [ build ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Build Plan
        uses: actions/download-artifact@v4
        with:
          name: build-plan

      - name: Download Spec
        uses: actions/download-artifact@v4
        with:
          name: specification
          path: .specular/

      - name: Run Drift Detection
        uses: ./
        with:
          command: 'eval'
          spec-file: '.specular/spec.yaml'
          plan-file: 'build-plan.json'
          policy-file: '.specular/policy.yaml'
          report-file: 'validation-report.sarif'
          fail-on-drift: 'true'
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload SARIF Report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: validation-report.sarif
          category: specular-build-validation
