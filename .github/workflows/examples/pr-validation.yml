# Example: Pull Request Validation with Specular
#
# This workflow validates pull requests by:
# 1. Checking for spec-code drift
# 2. Running policy checks
# 3. Uploading results to GitHub Security tab
#
# To use this workflow:
# 1. Copy to .github/workflows/pr-validation.yml
# 2. Set up required secrets (ANTHROPIC_API_KEY or OPENAI_API_KEY)
# 3. Customize policy and spec paths as needed

name: PR Validation

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'lib/**'
      - '.specular/**'
      - 'PRD.md'

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  validate:
    name: Validate PR with Specular
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Run Drift Detection
        uses: ./
        with:
          command: 'eval'
          spec-file: '.specular/spec.yaml'
          plan-file: 'plan.json'
          policy-file: '.specular/policy.yaml'
          report-file: 'drift-report.sarif'
          fail-on-drift: 'true'
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Comment PR with Results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## üîç Specular Validation Results\n\n';

            if (fs.existsSync('drift-report.sarif')) {
              const sarif = JSON.parse(fs.readFileSync('drift-report.sarif', 'utf8'));
              const results = sarif.runs[0].results || [];

              comment += `**Total Findings:** ${results.length}\n\n`;

              if (results.length > 0) {
                comment += '### Findings\n\n';
                results.slice(0, 10).forEach(r => {
                  const level = r.level || 'note';
                  const icon = level === 'error' ? '‚ùå' : level === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                  comment += `${icon} **${r.ruleId}**: ${r.message.text}\n`;
                });

                if (results.length > 10) {
                  comment += `\n_...and ${results.length - 10} more findings._\n`;
                }
              } else {
                comment += '‚úÖ No drift detected! Code matches specification.\n';
              }
            } else {
              comment += '‚ö†Ô∏è No SARIF report generated.\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload SARIF to Security Tab
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: drift-report.sarif
          category: specular-pr-validation
