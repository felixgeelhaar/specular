name: Performance

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Build binary
        run: |
          go build -ldflags="-s -w" -trimpath -o specular ./cmd/specular
          echo "BINARY_SIZE=$(stat -c%s specular)" >> $GITHUB_ENV

      - name: Check binary size
        run: |
          SIZE_MB=$(echo "scale=2; $BINARY_SIZE / 1048576" | bc)
          echo "Binary size: ${SIZE_MB}MB"

          # Fail if binary exceeds 25MB (generous threshold for CI)
          MAX_SIZE=26214400  # 25MB
          if [ "$BINARY_SIZE" -gt "$MAX_SIZE" ]; then
            echo "::error::Binary size (${SIZE_MB}MB) exceeds maximum (25MB)"
            exit 1
          fi

      - name: Measure startup time
        run: |
          # Version command (minimal init)
          echo "Measuring version command..."
          for i in {1..5}; do
            /usr/bin/time -f "%e" ./specular version 2>&1 | tail -1
          done

          # Help command
          echo "Measuring help command..."
          for i in {1..5}; do
            /usr/bin/time -f "%e" ./specular --help 2>&1 | tail -1
          done

      - name: Run Go benchmarks
        run: |
          go test -bench=. -benchmem -count=5 ./internal/metrics ./internal/spec | tee benchmark-results.txt

      - name: Download baseline (main branch)
        if: github.event_name == 'pull_request'
        uses: actions/cache/restore@v4
        with:
          path: baseline-benchmarks.txt
          key: benchmark-baseline-main
          restore-keys: |
            benchmark-baseline-

      - name: Compare with baseline
        if: github.event_name == 'pull_request' && hashFiles('baseline-benchmarks.txt') != ''
        id: compare
        run: |
          echo "## Benchmark Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run benchstat
          benchstat baseline-benchmarks.txt benchmark-results.txt > comparison.txt 2>&1 || true

          # Check for regressions (>10% slowdown)
          if grep -q '+.*%' comparison.txt; then
            echo "### Changes detected:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat comparison.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            # Check for significant regressions
            if grep -E '\+[1-9][0-9]\.[0-9]+%|\+[2-9][0-9]+' comparison.txt; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "::warning::Performance regression detected (>10%)"
            fi
          else
            echo "No significant performance changes detected." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Save baseline (main branch)
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: benchmark-results.txt
          key: benchmark-baseline-main-${{ github.sha }}

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmark-results.txt
            comparison.txt
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request' && hashFiles('comparison.txt') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('comparison.txt', 'utf8');
            const binarySize = process.env.BINARY_SIZE;
            const sizeMB = (parseInt(binarySize) / 1048576).toFixed(2);

            const body = `## Performance Report

            **Binary Size:** ${sizeMB}MB

            <details>
            <summary>Benchmark Comparison</summary>

            \`\`\`
            ${comparison}
            \`\`\`

            </details>

            *Run \`scripts/benchmark.sh\` locally for detailed analysis.*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
