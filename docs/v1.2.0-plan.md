# Specular v1.2.0 Implementation Plan

**Version:** 1.2.0 - CLI Enhancement
**Timeline:** Q1 2025
**Focus:** Enhanced user experience, smart defaults, and system diagnostics

---

## Overview

v1.2.0 addresses the critical user feedback: "users are quite lost with what to do" and "too many commands/flags without meaningful fallbacks". This release focuses on making Specular intuitive, helpful, and user-friendly.

## Features

### 1. Enhanced UX Helpers âœ… STARTED
**Priority:** P0
**Status:** In Progress
**Dependencies:** None

**Implementation:**
- âœ… Create `internal/ux/prompts.go` - Interactive prompt helpers
- âœ… Create `internal/ux/defaults.go` - Smart path defaults and validation
- âœ… Create `internal/ux/errors.go` - Enhanced error messages with suggestions
- ðŸš§ Apply to `spec` command
- ðŸš§ Apply to `plan` command
- ðŸš§ Apply to `build` command
- ðŸš§ Apply to `eval` command
- ðŸš§ Apply to `interview` command

**Acceptance Criteria:**
- [ ] All commands use smart defaults from PathDefaults
- [ ] Missing required files prompt interactively
- [ ] All errors include actionable suggestions
- [ ] Commands guide users through the workflow

---

### 2. Enhanced `specular init` with Smart Context Detection
**Priority:** P0
**Status:** Not Started
**Dependencies:** #1 (UX Helpers)

**Current State (v1.1.0):**
- Basic `.specular/` directory creation
- Interactive provider setup (ollama, openai, anthropic, gemini)
- Manual environment variable prompts

**Enhancements for v1.2.0:**

#### 2.1 Smart Context Detection Matrix
| Detector | Method | Output |
|----------|--------|---------|
| Docker/Podman | `docker info` | `docker: true/false` |
| Local Providers | `which ollama`, `which anthropic`, etc. | `providers: [...]` |
| Provider Keys | Prompt to read `.env` (with consent) | `provider_keys: [...]` |
| Languages | Detect `package.json`, `go.mod`, `pyproject.toml`, etc. | `frameworks: [...]` |
| API Specs | Detect `openapi.*`, `graphql.*`, `proto/*` | `api: true` |
| CI | Detect `.github/workflows`, `.gitlab-ci.yml`, etc. | `ci: [...]` |
| IDE/MCP | Detect `.vscode`, `.idea`, Cursor, Continue | `mcp: [...]` |
| Git | `git rev-parse --show-toplevel` | `git: {root, dirty}` |

#### 2.2 Additional Flags
```bash
specular init [path]
  [--template <name>]           # Presets: web-app, api-service, cli-tool, microservice, data-pipeline
  [--local|--cloud]             # Prefer local or cloud providers
  [--governance <L2|L3|L4>]     # Target governance level
  [--providers <csv>]           # Explicitly specify providers
  [--mcp enable|disable]        # Control MCP integration
  [--dry-run]                   # Preview without writing
  [--no-detect]                 # Skip auto-detection
  [--yes]                       # Auto-accept all prompts
```

#### 2.3 Generated Files
- `.specular/spec.yaml` - Skeleton with project context
- `.specular/routing.yaml` - Smart routing based on detected providers
- `.specular/policies/default.yaml` - Privacy-aware policies
- `.specular/settings.json` - Telemetry off, created timestamp, init flags

#### 2.4 Privacy-Preserving Design
- **Never upload code** - All detection is local
- **Explicit consent** - Prompt before reading `.env` or secrets
- **Diff preview** - Show all changes before writing
- **Confirmation required** - Unless `--yes` flag

**Implementation Tasks:**
- [ ] Create `internal/detect` package for context detection
- [ ] Implement Docker/Podman detection
- [ ] Implement provider CLI detection
- [ ] Implement language/framework detection (with privacy consent)
- [ ] Implement CI/IDE detection
- [ ] Implement Git context detection
- [ ] Add template system (web-app, api-service, etc.)
- [ ] Update `internal/cmd/init.go` with smart detection
- [ ] Add diff preview before writing files
- [ ] Generate `.specular/settings.json` with metadata
- [ ] Update routing.yaml generation based on detected context
- [ ] Add privacy prompts for sensitive file access

**Acceptance Criteria:**
- [ ] Auto-detects Docker availability
- [ ] Auto-detects installed AI provider CLIs
- [ ] Prompts for consent before reading `.env`
- [ ] Generates routing.yaml with detected providers enabled
- [ ] Shows diff preview before writing
- [ ] Saves init metadata to settings.json
- [ ] Works in non-interactive mode with `--yes`
- [ ] Respects privacy principles (no code upload)

---

### 3. `specular route` Command
**Priority:** P1
**Status:** Not Started
**Dependencies:** None

**Purpose:** Routing intelligence tools for understanding and optimizing model selection

**Subcommands:**
```bash
specular route show [--format table|json]
  # Display current routing configuration and provider status

specular route test [--task <interview|plan|build|eval>] [--feature <id>]
  # Test routing logic for a specific task

specular route explain [--task <x>] [--format json|text]
  # Explain why a specific model was selected for a task

specular route optimize [--since <date>] [--dry-run]
  # Analyze historical performance and suggest routing improvements

specular route bench [--models <csv>] [--tasks <csv>]
  # Benchmark model performance across tasks
```

**Implementation Tasks:**
- [ ] Create `internal/cmd/route.go`
- [ ] Implement `route show` - Display routing config
- [ ] Implement `route test` - Test routing logic
- [ ] Implement `route explain` - Explain model selection
- [ ] Implement `route optimize` - Performance analysis (basic)
- [ ] Implement `route bench` - Benchmark models
- [ ] Add JSON output support for all subcommands

**Acceptance Criteria:**
- [ ] `route show` displays current configuration
- [ ] `route test` validates routing logic
- [ ] `route explain` shows selection reasoning
- [ ] `route optimize` provides actionable suggestions
- [ ] `route bench` compares model performance
- [ ] All commands support `--format json`

---

### 4. `specular doctor` Command
**Priority:** P1
**Status:** Not Started
**Dependencies:** #2 (Enhanced init with detection)

**Purpose:** System diagnostics and health checks

**Functionality:**
```bash
specular doctor [--format json]
  # Check system health and configuration
```

**Checks:**
- Docker daemon running
- AI provider availability (ollama, anthropic, openai, gemini)
- `.specular/` directory structure
- Required files exist (spec.yaml, router.yaml, policy.yaml)
- Policy compliance
- Provider credentials/API keys
- Disk space for cache
- Git repository status

**Output (JSON):**
```json
{
  "docker": {"running": true, "version": "24.0.7"},
  "providers": {
    "ollama": true,
    "anthropic": false,
    "openai": true
  },
  "spec": {"exists": true, "locked": true, "valid": true},
  "policy": {"exists": true, "violations": []},
  "git": {"initialized": true, "clean": false, "uncommitted": 3},
  "disk": {"cache_size_mb": 256, "available_mb": 50000},
  "next_steps": "Run 'specular build' to execute your plan"
}
```

**Implementation Tasks:**
- [ ] Create `internal/cmd/doctor.go`
- [ ] Implement Docker health check
- [ ] Implement provider availability checks
- [ ] Implement spec/policy validation checks
- [ ] Implement Git status check
- [ ] Implement disk space check
- [ ] Generate actionable next steps
- [ ] Add colored text output for terminal
- [ ] Add JSON output mode

**Acceptance Criteria:**
- [ ] Detects Docker daemon status
- [ ] Checks all provider availability
- [ ] Validates `.specular/` structure
- [ ] Identifies policy violations
- [ ] Provides specific next steps
- [ ] Supports both text and JSON output
- [ ] Exit code 0 if healthy, 1 if issues found

---

### 5. Global Flag Improvements
**Priority:** P2
**Status:** Not Started
**Dependencies:** #1 (UX Helpers)

**New Global Flags:**
```bash
specular [global-flags] <command> [command-flags]

Global Flags:
  --version                 # Show version information
  --verbose, -v             # Verbose output
  --quiet, -q               # Suppress non-essential output
  --format <auto|text|json|yaml>  # Output format
  --cwd <path>              # Working directory (default: current)
  --color <auto|always|never>  # Color output
  --explain                 # Explain what each step does
  --trace                   # Add trace IDs to all operations
```

**Environment Variables:**
```bash
SPECULAR_HOME            # Defaults to ~/.specular
SPECULAR_TOKEN           # Auth for Cloud/Pro
SPECULAR_TELEMETRY       # on|off (default: off)
SPECULAR_NO_NETWORK      # Force offline behavior
SPECULAR_LOG_LEVEL       # debug|info|warn|error
```

**Implementation Tasks:**
- [ ] Add global flags to `internal/cmd/root.go`
- [ ] Implement `--explain` mode
- [ ] Implement `--trace` for operation correlation
- [ ] Add environment variable parsing
- [ ] Update all commands to respect global flags

**Acceptance Criteria:**
- [ ] All global flags work across all commands
- [ ] `--explain` provides step-by-step narration
- [ ] `--trace` adds correlation IDs
- [ ] Environment variables override defaults
- [ ] `--quiet` suppresses progress indicators

---

### 6. Exit Code Standardization
**Priority:** P2
**Status:** Not Started
**Dependencies:** #1 (UX Helpers)

**Exit Codes:**
| Code | Meaning | Source |
|------|---------|--------|
| 0 | Success | All operations |
| 1 | Generic error | Unexpected failures |
| 2 | Usage error | Invalid flags/arguments |
| 3 | Policy violation | Policy checks failed |
| 4 | Drift detected | Spec/code misalignment |
| 5 | Auth error | Authentication failed |
| 6 | Network error | Connection issues |

**Implementation Tasks:**
- [ ] Create `internal/exitcodes` package
- [ ] Update all commands to use standardized codes
- [ ] Document exit codes in command help
- [ ] Add exit code mapping to errors

**Acceptance Criteria:**
- [ ] All commands use standardized exit codes
- [ ] CI/CD can distinguish error types
- [ ] Help text documents exit codes

---

## Implementation Order

### Sprint 1: Foundation (Week 1)
1. âœ… Enhanced UX Helpers (#1) - STARTED
2. Apply UX helpers to all existing commands
3. Global flag improvements (#5)
4. Exit code standardization (#6)

### Sprint 2: Detection & Diagnostics (Week 2)
5. Enhanced `init` with smart detection (#2)
6. `specular doctor` command (#4)

### Sprint 3: Routing Intelligence (Week 3)
7. `specular route` command (#3)
8. Integration testing
9. Documentation updates

---

## Testing Strategy

**Unit Tests:**
- [ ] All UX helper functions
- [ ] Context detection functions
- [ ] Routing logic
- [ ] Doctor health checks

**Integration Tests:**
- [ ] Full `init` workflow with detection
- [ ] `doctor` checks in various states
- [ ] `route` command scenarios
- [ ] Error handling and suggestions

**Manual Testing:**
- [ ] New user onboarding (fresh install)
- [ ] Error recovery scenarios
- [ ] Interactive prompts
- [ ] Different OS environments (macOS, Linux, Windows)

---

## Documentation Updates

**Required Documentation:**
- [ ] Update README.md with v1.2.0 features
- [ ] Add `specular route` reference
- [ ] Add `specular doctor` reference
- [ ] Update `specular init` documentation
- [ ] Add troubleshooting guide using `doctor`
- [ ] Update global flags reference
- [ ] Add exit code reference

---

## Success Metrics

**Quantitative:**
- [ ] 90%+ of users complete setup successfully without errors
- [ ] Average time to first successful build < 5 minutes
- [ ] 80%+ reduction in "file not found" errors (via smart defaults)
- [ ] 100% of errors include actionable suggestions

**Qualitative:**
- [ ] User feedback: "Easy to get started"
- [ ] User feedback: "Errors are helpful"
- [ ] No confusion about "what to do next"
- [ ] Clear workflow progression

---

## Release Checklist

- [ ] All acceptance criteria met
- [ ] Unit test coverage >80%
- [ ] Integration tests passing
- [ ] Manual testing on all platforms
- [ ] Documentation updated
- [ ] CHANGELOG.md updated
- [ ] Migration guide (if needed)
- [ ] Release notes drafted
- [ ] Tag version v1.2.0
- [ ] Build artifacts generated
- [ ] Homebrew formula updated
- [ ] AUR package updated
